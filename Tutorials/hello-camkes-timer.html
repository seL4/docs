<!DOCTYPE html>
<!--
     SPDX-License-Identifier: CC-BY-SA-4.0
     SPDX-FileCopyrightText: 2020 seL4 Project a Series of LF Projects, LLC.
-->
<!-- Page last generated 2023-02-07 03:18:25 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Camkes 3 | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117737473-2"></script>
<script>
  if((window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window['ga-disable-UA-117737473-2'] = true;
  }
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117737473-2');
</script>
</head>

  <body class="container-fluid">

    



<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="https://sel4.systems" class="skip-icon">
              <img class="img-responsive" src="/assets/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/processes">Contributing</a></h2>
        <h2><a href="/projects">Projects</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <iframe title="DuckDuckGo search bar" src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search%20sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;border-width: 0px"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  
<div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
            </a>
            <meta property="position" content="1" />
        </li>
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/Tutorials/">
              <span property="name"><b>Tutorials</b></span>
            </a>
            <meta property="position" content="2" />
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">Camkes 3</span>
            <meta property="position" content="3" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/releases/sel4/12.1.0"><b>seL4-12.1.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/camkes/camkes-3.10.0"><b>camkes-3.10.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/releases/capdl/0.2.1"><b>CapDL-0.2.1</b></a></li>
    </ol>
  </nav>
  <nav class="sel-version">
    <ol class="list-unstyled">
      <li class="list-unstyled text-center">
      <a href="https://sel4.discourse.group/t/15-june-2021-release/373"><b>Announcing new releases: </b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      <div class="row">
  <div class="hidden-xs col-sm-4 col-md-3 col-lg-2">
    


<div class="sidebar">


















    <ul class="nav nav-sidebar">
  
  
        <li class="">
            <a class="" href="/Tutorials/hello-world.html">Hello, World!</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-0.html">Camkes</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-1.html">Camkes 1</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-2.html">Camkes 2</a>
        <li>
  
        <li class="active">
            <a class="" href="/Tutorials/hello-camkes-timer.html">Camkes 3</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-1.html">Dynamic Libraries 1</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-2.html">Dynamic Libraries 2</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-3.html">Dynamic Libraries 3</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-4.html">Dynamic Libraries 4</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/mcs.html">MCS</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/capabilities.html">Capabilities</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/untyped.html">Untyped</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/mapping.html">Mapping</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/threads.html">Threads</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/ipc.html">IPC</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/notifications.html">Notifications</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/interrupts.html">Interrupts</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/fault-handlers.html">Faults</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/camkes-vm-linux.html">Camkes VM Linux</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/camkes-vm-crossvm.html">Camkes Cross-VM communication</a>
        <li>
  
    </ul>

</div>


  </div>
  <div class="col-sm-8 col-md-9 col-lg-8 main">
    
      <nav aria-label="Table of Contents">
        <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#initialising">Initialising</a></li>
<li class="toc-entry toc-h2"><a href="#prerequisites">Prerequisites</a></li>
<li class="toc-entry toc-h2"><a href="#exercises---part-1">Exercises - Part 1</a>
<ul>
<li class="toc-entry toc-h3"><a href="#task-1">TASK 1</a></li>
<li class="toc-entry toc-h3"><a href="#task-2">TASK 2</a></li>
<li class="toc-entry toc-h3"><a href="#task-3">TASK 3</a></li>
<li class="toc-entry toc-h3"><a href="#task-4">TASK 4</a></li>
<li class="toc-entry toc-h3"><a href="#task-5">TASK 5</a></li>
<li class="toc-entry toc-h3"><a href="#task-6">TASK 6</a></li>
<li class="toc-entry toc-h3"><a href="#task-7">TASK 7</a></li>
<li class="toc-entry toc-h3"><a href="#task-8">TASK 8</a></li>
<li class="toc-entry toc-h3"><a href="#task-9">TASK 9</a></li>
<li class="toc-entry toc-h3"><a href="#task-10">TASK 10</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#exercises---part-2">Exercises - Part 2</a>
<ul>
<li class="toc-entry toc-h3"><a href="#task-1-1">TASK 1</a></li>
<li class="toc-entry toc-h3"><a href="#task-2-1">TASK 2</a></li>
<li class="toc-entry toc-h3"><a href="#task-3-1">TASK 3</a></li>
<li class="toc-entry toc-h3"><a href="#task-4-1">TASK 4</a></li>
<li class="toc-entry toc-h3"><a href="#task-5-1">TASK 5</a></li>
<li class="toc-entry toc-h3"><a href="#task-6-1">TASK 6</a></li>
<li class="toc-entry toc-h3"><a href="#task-7---10">TASK 7 - 10</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#getting-help">Getting help</a></li>
</ul>
      </nav>
    
    <div class="content">
      
<!--
  Copyright 2019, Data61, CSIRO (ABN 41 687 119 230)

  SPDX-License-Identifier: BSD-2-Clause
-->

<h1 id="camkes-timer-tutorial">CAmkES Timer Tutorial</h1>

<p>This tutorial guides you through setting up a sample timer driver component in
CAmkES and using it to delay for 2 seconds. For this tutorial, we will be using
the ZYNQ7000 ARM-based platform. This platform can be simulated via QEMU so it
is not a problem if you do not have access to the actual physical board.</p>

<p>The tutorial also has two parts to it. The first part will teach you how to
manually define hardware details to configure the hardware component and
initialise hardware resources.  The second part will teach you how to use a
CAmkES connector to initialise hardware resources automatically for you.</p>

<p>The solutions to this tutorial primarily uses the method of manually defining
hardware details. The solutions to the second part are also included, albeit
commented out.</p>

<h2 id="initialising">Initialising</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># For instructions about obtaining the tutorial sources see https://docs.sel4.systems/Tutorials/#get-the-code</span>
<span class="c">#</span>
<span class="c"># Follow these instructions to initialise the tutorial</span>
<span class="c"># initialising the build directory with a tutorial exercise</span>
./init <span class="nt">--tut</span> hello-camkes-timer
<span class="c"># building the tutorial exercise</span>
<span class="nb">cd </span>hello-camkes-timer_build
ninja
</code></pre></div></div>

<h2 id="prerequisites">Prerequisites</h2>

<ol>
  <li><a href="https://docs.sel4.systems/HostDependencies">Set up your machine</a>.</li>
  <li><a href="https://docs.sel4.systems/Tutorials/hello-camkes-2">Camkes 2</a></li>
</ol>

<h2 id="exercises---part-1">Exercises - Part 1</h2>

<h3 id="task-1">TASK 1</h3>

<p>Start in <code class="highlighter-rouge">hello-camkes-timer.camkes</code>.</p>

<p>Instantiate some components. You’re already given one component instance</p>
<ul>
  <li><code class="highlighter-rouge">client</code>. You need to instantiate additional components, a timer driver and
a component instance representing the timer hardware itself. Look
in <code class="highlighter-rouge">components/Timer/Timer.camkes</code> for the definitions of the components.</li>
</ul>

<p>Once you open the file, you will notice three different components. The <code class="highlighter-rouge">Timer</code>
and <code class="highlighter-rouge">Timerbase</code> components represents the timer driver and the timer hardware
respectively. The <code class="highlighter-rouge">TimerDTB</code> component represents both the timer driver and the
timer hardware. This component is meant to be used with the <code class="highlighter-rouge">seL4DTBHardware</code>
CAmkES connector to automatically initialise hardware resources. The second
part of the tutorial will go into more detail about the <code class="highlighter-rouge">TimerDTB</code> component
and the <code class="highlighter-rouge">seL4DTBHardware</code> connector.</p>

<p>For now, instantiate the <code class="highlighter-rouge">Timer</code> and <code class="highlighter-rouge">Timerbase</code> components.</p>

<p>Note the lines <code class="highlighter-rouge">connection seL4RPCCall hello_timer(from client.hello, to
timer.hello);</code> and <code class="highlighter-rouge">timer.sem_value = 0;</code> in the <code class="highlighter-rouge">hello-camkes-timer.camkes</code>
file. They assume that the name of the timer ‘‘driver’’ will be <code class="highlighter-rouge">timer</code>. If you
wish to call your driver something else, you’ll have to change these lines.</p>

<h3 id="task-2">TASK 2</h3>

<p>Connect the timer driver component (<code class="highlighter-rouge">Timer</code>) to the timer hardware component
(<code class="highlighter-rouge">Timerbase</code>). The timer hardware component exposes two interfaces which must
be connected to the timer driver. One of these represents memory-mapped
registers. The other represents an interrupt.</p>

<h3 id="task-3">TASK 3</h3>

<p>Configure the timer hardware component instance with device-specific info. The
physical address of the timer’s memory-mapped registers, and its IRQ number
must both be configured.</p>

<h3 id="task-4">TASK 4</h3>

<p>Now open <code class="highlighter-rouge">components/Timer/src/timer.c</code>.</p>

<p>We’ll start by completing the <code class="highlighter-rouge">irq_handle</code> function, which is called in
response to each timer interrupt. Note the name of this function. It follows
the naming convention <code class="highlighter-rouge">&lt;interface&gt;_handle</code>, where <code class="highlighter-rouge">&lt;interface&gt;</code> is the name of
an IRQ interface connected with <code class="highlighter-rouge">seL4HardwareInterrupt</code>. When an interrupt is
received on the interface <code class="highlighter-rouge">&lt;interface&gt;</code>, the function <code class="highlighter-rouge">&lt;interface&gt;_handle</code> will
be called.</p>

<p>The implementation of the timer driver is located inside a different folder and
can be found in the <code class="highlighter-rouge">projects/sel4-tutorials/zynq_timer_driver</code> folder from the
root of the projects directory, i.e. where the <code class="highlighter-rouge">.repo</code> folder can be found and
where the initial <code class="highlighter-rouge">repo init</code> command was executed.</p>

<p>This task is to call the <code class="highlighter-rouge">timer_handle_irq</code> function from the supply driver to
inform the driver that an interrupt has occurred.</p>

<h3 id="task-5">TASK 5</h3>

<p>Stop the timer from running. The <code class="highlighter-rouge">timer_stop</code> function will be helpful here.</p>

<h3 id="task-6">TASK 6</h3>

<p>The interrupt now needs to be acknowledged.</p>

<p>CAmkES generates the seL4-specific code for ack-ing an interrupt and provides a
function <code class="highlighter-rouge">&lt;interface&gt;_acknowldege</code> for IRQ interfaces (specifically those
connected with <code class="highlighter-rouge">seL4HardwareInterrupt</code>).</p>

<h3 id="task-7">TASK 7</h3>

<p>Now we’ll complete <code class="highlighter-rouge">hello__init</code> - a function which is called once
before the component’s interfaces start running.</p>

<p>We need to initialise a handle to the timer driver for this device, and store a
handle to the driver in the global variable <code class="highlighter-rouge">timer_drv</code>.</p>

<h3 id="task-8">TASK 8</h3>

<p>After initialising the timer, we now need to start the timer. Do so by calling
<code class="highlighter-rouge">timer_start</code> and passing the handle to the driver.</p>

<h3 id="task-9">TASK 9</h3>

<p>Note that this task is to understand the existing code. You won’t have
to modify anything for this task.</p>

<p>Implement the <code class="highlighter-rouge">timer_inf</code> RPC interface. This interface is defined in
<code class="highlighter-rouge">interfaces/timer.camkes</code>, and contains a single method, <code class="highlighter-rouge">sleep</code>, which
should return after a given number of seconds. in
<code class="highlighter-rouge">components/Timer/Timer.camkes</code>, we can see that the <code class="highlighter-rouge">timer_inf</code> interface
exposed by the <code class="highlighter-rouge">Timer</code> component is called <code class="highlighter-rouge">hello</code>. Thus, the function we
need to implement is called <code class="highlighter-rouge">hello_sleep</code>.</p>

<h3 id="task-10">TASK 10</h3>

<p>Tell the timer to interrupt after the given number of seconds. The
<code class="highlighter-rouge">timer_set_timeout</code> function from the included driver will help. Note that it
expects its time argument to be given in nanoseconds.</p>

<p>Note the existing code in <code class="highlighter-rouge">hello_sleep</code>. It waits on a binary semaphore.
<code class="highlighter-rouge">irq_handle</code> will be called on another thread when the timer interrupt occurs,
and that function will post to the binary semaphore, unblocking us and allowing
the function to return after the delay.</p>

<p>Expect the following output with a 2 second delay between the last 2
lines:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting the client
------Sleep for 2 seconds------
After the client: wakeup
</code></pre></div></div>

<h2 id="exercises---part-2">Exercises - Part 2</h2>

<p>Now that you’ve learnt how to manually define the hardware details of a
hardware component to initialise hardware resources, this part of the tutorial
will teach you how to use the <code class="highlighter-rouge">seL4DTBHardware</code> connector to do that
automatically.</p>

<p>The connector requires a devicetree blob which describes an ARM platform.
Additionally, the blob’s interrupt fields also need to follow the same format
of the ARM GIC v1 and v2. There are devicetree source files bundled with the
kernel, look in the <code class="highlighter-rouge">tools/dts/</code> folder of the kernel sources. If a suitable
devicetree blob is not available for your platform, then do not proceed with
the tutorial.</p>

<h3 id="task-1-1">TASK 1</h3>

<p>Navigate to the <code class="highlighter-rouge">hello-camkes-timer.camkes</code> file.</p>

<p>Remove the <code class="highlighter-rouge">Timerbase</code> and <code class="highlighter-rouge">Timer</code> component instantiations and instantiate a
<code class="highlighter-rouge">TimerDTB</code> component instead. Also change the <code class="highlighter-rouge">connection seL4RPCCall
hello_timer(from client.hello, to timer.hello);</code> and <code class="highlighter-rouge">timer.sem_value = 0;</code>
lines if necessary.</p>

<h3 id="task-2-1">TASK 2</h3>

<p>Remove the <code class="highlighter-rouge">seL4HardwareMMIO</code> and <code class="highlighter-rouge">seL4HardwareInterrupt</code> connections. Connect
the two interfaces inside the <code class="highlighter-rouge">TimerDTB</code> component with the <code class="highlighter-rouge">seL4DTBHardware</code>
connector.</p>

<h3 id="task-3-1">TASK 3</h3>

<p>Before opening <code class="highlighter-rouge">components/Timer/Timer.camkes</code>, remove the <code class="highlighter-rouge">Timerbase</code> settings
inside the configurations block.</p>

<p>Configure the <code class="highlighter-rouge">TimerDTB</code> component to pass in the correct DTB path to a timer
to the connector and also initialise the interrupt resources for the timer.
This will allow the connector to read a device node from the devicetree blob
and grab the necessary data to initialise hardware resources. More
specifically, it reads the registers field and optionally the interrupts field
to allocate memory and interrupts.</p>

<h3 id="task-4-1">TASK 4</h3>

<p>Move to <code class="highlighter-rouge">components/TimerDTB/src/timerdtb.c</code>.</p>

<p>Similar to part one, we’ll start with the <code class="highlighter-rouge">tmr_irq_handle</code> function. This
function is called in response to a timer interrupt. The name of the function
has a special meaning and the meaning is unique to the <code class="highlighter-rouge">seL4DTBHardware</code>
connector.</p>

<p>The IRQ handling functions of the connector follows the naming convention
<code class="highlighter-rouge">&lt;to_interface&gt;_irq_handle</code>, where <code class="highlighter-rouge">&lt;to_interface&gt;</code> is the name of the
interface of the ‘to’ end in an instance of a <code class="highlighter-rouge">seL4DTBHardware</code> connection.
Also notice that it takes a <code class="highlighter-rouge">ps_irq_t *</code> type. This is because, for a given
device, there may be multiple interrupts associated with the device. A
<code class="highlighter-rouge">ps_irq_t</code> struct is given to the IRQ handling function and it contains
information about the interrupt, allowing the handler to differentiate between
the numerous interrupts of a device.</p>

<p>Likewise with part one, the implementation of the timer driver is in the
included driver in <code class="highlighter-rouge">timer_driver</code> and the task here is to call
<code class="highlighter-rouge">timer_handle_irq</code>.</p>

<h3 id="task-5-1">TASK 5</h3>

<p>The timer needs to be stopped, the task here is the same as part one’s task 5.</p>

<h3 id="task-6-1">TASK 6</h3>

<p>Again, the interrupt now has to be acknowledged.</p>

<p>For the <code class="highlighter-rouge">seL4DTBHardware</code> connector, CAmkES also generates and provides a
function to acknowledge interrupts. This function follows a similar naming
convention to the IRQ handler above, <code class="highlighter-rouge">&lt;to_interface&gt;_irq_acknowledge</code> also
takes in a <code class="highlighter-rouge">ps_irq_t *</code> argument. Similarly, the <code class="highlighter-rouge">ps_irq_t *</code> argument helps
CAmkES to differentiate between the possibly many interrupts of a device that
you wish to acknowledge.</p>

<h3 id="task-7---10">TASK 7 - 10</h3>

<p>Task 7 to 10 are the exact same as the tasks in part one.</p>

<p>You should also expect the same output as the first part.</p>

<hr />
<h2 id="getting-help">Getting help</h2>
<p>Stuck? See the resources below.</p>
<ul>
  <li><a href="https://docs.sel4.systems/FrequentlyAskedQuestions">FAQ</a></li>
  <li><a href="http://sel4.systems/Info/Docs/seL4-manual-latest.pdf">seL4 Manual</a></li>
  <li><a href="https://docs.sel4.systems/DebuggingGuide.html">Debugging guide</a></li>
  <li><a href="https://sel4.discourse.group">seL4 Discourse forum</a></li>
  <li><a href="https://lists.sel4.systems/postorius/lists/devel.sel4.systems/">Developer’s mailing list</a></li>
  <li><a href="https://mattermost.trustworthy.systems/sel4-external/">Mattermost Channel</a></li>
</ul>

<hr />

<p><em>Tutorial included from <a href="https://github.com/sel4/sel4-tutorials/blob/master/tutorials/
hello-camkes-timer/hello-camkes-timer.md">github repo</a> <a href="https://github.com/sel4/sel4-tutorials/edit/master/tutorials/
hello-camkes-timer/hello-camkes-timer.md">edit</a></em></p>


    </div>
  </div>
</div>

    </main>
    


<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      



<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Thu Jan 12 15:17:30 2023 +1100 dc9a925
          </li>
          <li>
                Page last updated: Thu Jan 12 15:17:30 2023 +1100 dc9a925
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
<a href="https://github.com/seL4/docs/blob/master/Tutorials/hello-camkes-timer.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/seL4/docs/edit/master/Tutorials/hello-camkes-timer.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>

  </body>
</html>
