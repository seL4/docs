<!DOCTYPE html>
<!-- Page last generated 2018-11-06 09:22:51 +1100 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Untyped | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css"><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117737473-2"></script>
<script>
  if((window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window['ga-disable-UA-117737473-2'] = true;
  }
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117737473-2');
</script>
</head>

  <body class="container-fluid">

    

<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="/">
              <img class="img-responsive" src="/logos/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/Documentation">Documentation</a></h2>
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <h2><a href="https://research.csiro.au/tsblog">Blog</a></h2>
        <iframe title="DuckDuckGo search bar" src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search%20sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;border-width: 0px"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  <div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
              <meta property="position" content="1" />
            </a>
        </li>
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/Tutorials/">
              <span property="name"><b></b></span>
              <meta property="position" content="2" />
            </a>
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">Untyped</span>
            <meta property="position" content="3" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_10.0.0"><b>seL4-10.0.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_9.0.0-mcs"><b>seL4-9.0.0-mcs</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/camkes_release/CAmkES_3.5.0"><b>camkes-3.5.0</b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      <div class="row">
  <div class="hidden-xs col-sm-4 col-md-3 col-lg-2">
    <div class="sidebar">

    <h3>seL4</h3>
      <ul class="nav nav-sidebar">
  
        <li class="">
          <a class="" href="/GettingStarted.html">
            Getting Started
          </a>
        </li>
  
        <li class="">
          <a class="" href="/Developing/Building/">
            CMake Build System
          </a>
        </li>
  
        <li class="">
          <a class="" href="/FrequentlyAskedQuestions.html">
            FAQ
          </a>
        </li>
  
        <li class="">
          <a class="" href="/Hardware/">
            Hardware
          </a>
        </li>
  
        <li class="">
          <a class="" href="/CAmkES/">
            CAmkES
          </a>
        </li>
  
        <li class="">
          <a class="" href="/sel4_release/">
            Release Notes
          </a>
        </li>
  
        <li class="">
          <a class="" href="/ApiDoc.html">
            libsel4 API
          </a>
        </li>
  
        <li class="">
          <a class="" href="https://sel4.systems/Info/Docs/seL4-manual-latest.pdf">
            Current Manual
          </a>
        </li>
  
      </ul>

    <h3>Community</h3>
      <ul class="nav nav-sidebar">
  
        <li class="">
          <a class="" href="/Conduct.html">
            Code of Conduct
          </a>
        </li>
  
        <li class="">
          <a class="" href="/Contributing.html">
            Contributing
          </a>
        </li>
  
        <li class="">
          <a class="" href="https://research.csiro.au/tsblog">
            Trustworthy Systems Blog
          </a>
        </li>
  
        <li class="">
          <a class="" href="/IRCChannel.html">
            IRC Channel
          </a>
        </li>
  
        <li class="">
          <a class="" href="/SuggestedProjects.html">
            Suggested projects
          </a>
        </li>
  
        <li class="">
          <a class="" href="/CommunityProjects.html">
            Community Projects
          </a>
        </li>
  
      </ul>


  <h3><a href="/Tutorials">Tutorials</a></h3>
    <ul class="nav nav-sidebar">
  
  
        <li class="">
            <a class="" href="/Tutorials/hello-world.html">Hello, World!</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-0.html">Camkes</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-1.html">Camkes 1</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-2.html">Camkes 2</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-timer.html">Camkes 3</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-1.html">Dynamic Libraries 1</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-2.html">Dynamic Libraries 2</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-3.html">Dynamic Libraries 3</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-4.html">Dynamic Libraries 4</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/mcs.html">MCS</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/capabilities.html">Capabilities</a>
        <li>
  
        <li class="active">
            <a class="" href="/Tutorials/untyped.html">Untyped</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/mapping.html">Mapping</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/threads.html">Threads</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/ipc.html">IPC</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/notifications.html">Notifications</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/interrupts.html">Interrupts</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/camkes-vm-linux.html">Camkes VM Linux</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/camkes-vm-crossvm.html">Camkes Cross-VM communication</a>
        <li>
  
    </ul>
</div>


  </div>
  <div class="col-sm-8 col-md-9 col-lg-8 main">
    
      <nav aria-label="Table of Contents">
        <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#prerequisites">Prerequisites</a></li>
<li class="toc-entry toc-h2"><a href="#outcomes">Outcomes</a></li>
<li class="toc-entry toc-h2"><a href="#background">Background</a>
<ul>
<li class="toc-entry toc-h3"><a href="#physical-memory">Physical memory</a></li>
<li class="toc-entry toc-h3"><a href="#untyped">Untyped</a></li>
<li class="toc-entry toc-h3"><a href="#initial-state">Initial state</a></li>
<li class="toc-entry toc-h3"><a href="#retyping">Retyping</a>
<ul>
<li class="toc-entry toc-h4"><a href="#types">Types</a></li>
<li class="toc-entry toc-h4"><a href="#size">Size</a></li>
<li class="toc-entry toc-h4"><a href="#root-node_index--node_depth">Root, node_index & node_depth</a></li>
<li class="toc-entry toc-h4"><a href="#node_offset">Node_offset</a></li>
<li class="toc-entry toc-h4"><a href="#num_caps">Num_caps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#exercises">Exercises</a>
<ul>
<li class="toc-entry toc-h3"><a href="#create-an-untyped">Create an untyped</a></li>
<li class="toc-entry toc-h3"><a href="#create-a-tcb-object">Create a TCB Object</a></li>
<li class="toc-entry toc-h3"><a href="#create-an-endpoint-object">Create an endpoint object</a></li>
<li class="toc-entry toc-h3"><a href="#create-a-notification-object">Create a notification object</a></li>
<li class="toc-entry toc-h3"><a href="#delete-the-objects">Delete the objects</a></li>
<li class="toc-entry toc-h3"><a href="#further-exercises">Further exercises</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#getting-help">Getting help</a></li>
</ul>
      </nav>
    
    <div class="content">
      
<h1 id="untyped">Untyped</h1>

<p>This tutorial provides an introduction to physical memory management on seL4.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ol>
  <li><a href="https://docs.sel4.systems/HostDependencies">Set up your machine</a>.</li>
  <li><a href="https://docs.sel4.systems/Tutorials/capabilities">Capabilities tutorial</a></li>
</ol>

<h2 id="outcomes">Outcomes</h2>

<p>By the end of this tutorial, you should be familiar with:</p>

<ol>
  <li>The jargon <em>untyped</em> and <em>device untyped</em>.</li>
  <li>Know how to create objects from untyped memory in seL4.</li>
  <li>Know how to reclaim objects.</li>
</ol>

<h2 id="background">Background</h2>

<h3 id="physical-memory">Physical memory</h3>

<p>Apart from a small, static amount of kernel memory, all physical memory is managed by user-level in an seL4
system. Capabilities to objects created by seL4 at boot, as well as the rest of the physical resources managed by seL4,
are passed to the root task on start up.</p>

<h3 id="untyped-1">Untyped</h3>

<p>Excluding the objects used to create the root task, capabilities to all available physical memory are passed to
the root task as capabilities to <em>untyped</em> memory. Untyped memory is a block of contiguous physical memory with
a specific size. Untyped objects have a boolean property <em>device</em> which indicates whether the memory is writable
by the kernel or not: if memory is <em>device</em> memory, it is not backed by RAM but some other device. Device untyped can
only be retyped as frame objects (physical memory frames, which can be mapped into virtual memory), and cannot be
written to by the kernel.</p>

<h3 id="initial-state">Initial state</h3>

<p>The <code class="highlighter-rouge">seL4_BootInfo</code> structure provided to the root task describes all of the untyped capabilities, including their size,
if they are a device untyped, and the physical address of the untyped. The code example below
shows how to print out the initial untyped capabilities provided from <code class="highlighter-rouge">seL4_BootInfo</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">printf</span><span class="p">(</span><span class="s">"    CSlot   </span><span class="se">\t</span><span class="s">Paddr           </span><span class="se">\t</span><span class="s">Size</span><span class="se">\t</span><span class="s">Type</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">seL4_CPtr</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">untyped</span><span class="p">.</span><span class="n">start</span><span class="p">;</span> <span class="n">slot</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">untyped</span><span class="p">.</span><span class="n">end</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">seL4_UntypedDesc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">untypedList</span><span class="p">[</span><span class="n">slot</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">untyped</span><span class="p">.</span><span class="n">start</span><span class="p">];</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%8p</span><span class="se">\t</span><span class="s">%16p</span><span class="se">\t</span><span class="s">2^%d</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">slot</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">sizeBits</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">isDevice</span> <span class="o">?</span> <span class="s">"device untyped"</span> <span class="o">:</span> <span class="s">"untyped"</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="retyping">Retyping</h3>

<p>Untyped capabilities have a single invocation: <a href="https://docs.sel4.systems/ApiDoc.html#retype">seL4_Untyped_Retype</a>
which is used to create a new capability from an untyped. Specifically, the new capability created by
a retype invocation provides access to the a subset of the memory range granted by the original untyped,
 with a specific type. New capabilities created by retyping an untyped object are referred to as <em>children</em> of
 that untyped object.</p>

<p>Untyped objects are retyped incrementally in a greedy fashion from the invoked untyped, which is important
to understand in order to gain efficient memory utilisation in seL4 systems. Each untyped object maintains
a single watermark, with addresses before the watermark being unavailable (already retyped) and after the
watermark being free (not retyped yet). On a retype operation, the watermark is moved first to the alignment
of the object being created, and then to the end of the size of the object. For example, if a 4KiB object is
created from an untyped, then a 16KiB object is created, the 12KiB between the end of the 4KiB object and
the start of the 16KiB object is wasted due to alignment. The memory cannot be reclaimed until both children are
revoked.</p>

<p>TL;DR: Untyped objects should be allocated in order of size, largest first, to avoid wasting memory.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">error</span> <span class="o">=</span> <span class="n">seL4_Untyped_Retype</span><span class="p">(</span><span class="n">parent_untyped</span><span class="p">,</span> <span class="c1">// the untyped capability to retype
</span>                                <span class="n">seL4_UntypedObject</span><span class="p">,</span> <span class="c1">// type
</span>                                <span class="n">untyped_size_bits</span><span class="p">,</span>  <span class="c1">//size
</span>                                <span class="n">seL4_CapInitThreadCNode</span><span class="p">,</span> <span class="c1">// root
</span>                                <span class="mi">0</span><span class="p">,</span> <span class="c1">// node_index
</span>                                <span class="mi">0</span><span class="p">,</span> <span class="c1">// node_depth
</span>                                <span class="n">child_untyped</span><span class="p">,</span> <span class="c1">// node_offset
</span>                                <span class="mi">1</span> <span class="c1">// num_caps
</span>                                <span class="p">);</span>
</code></pre></div></div>

<p>The above code snippet shows an example of retyping an untyped into a smaller, 4KiB untyped object.
We’ll refer to this snippet as we discuss each parameter in the retype invocation. Recall that the first
parameter is the untyped capability being invoked to do the retype.</p>

<h4 id="types">Types</h4>

<p>Each object in seL4 has a specific type, and all of the type constants can be found in <code class="highlighter-rouge">libsel4</code>. Some types
are architecture specific, while others are general across architectures. In the example above, we create a
new untyped object, which can be further retyped. The type of the created object determines the invocations
that can be made on that object. For example, were we to retype the object into a thread control block
(TCB – <code class="highlighter-rouge">seL4_TCBObject</code>), we could then perform TCB invocations on the object, including <code class="highlighter-rouge">seL4_TCB_SetPriority</code>.</p>

<h4 id="size">Size</h4>

<p>The size argument determines the size of the new object and is specified in <code class="highlighter-rouge">size_bits</code>, where the corresponding object
 size is the exponentiation, where <code class="highlighter-rouge">size_bits</code> is the exponent and the base is 2. In other words,
 the object size is 2<sup><code class="highlighter-rouge">size_bits</code></sup> in bytes.</p>

<p>All seL4 objects must be powers of 2 in size, however some objects are fixed-size while other objects are
 variable in size. The size parameter is <em>ignored</em> for fixed-sized objects and only respected by the kernel for
 variably-sized objects. Variably sized objects include untypeds (<code class="highlighter-rouge">seL4_UntypedObject</code>), CNodes (<code class="highlighter-rouge">seL4_CapTableObject</code>)
 and frame objects, of which the latter are architecture dependent.</p>

<h4 id="root-node_index--node_depth">Root, node_index &amp; node_depth</h4>

<p>The <code class="highlighter-rouge">root</code>, <code class="highlighter-rouge">node_index</code> and <code class="highlighter-rouge">node_depth</code> parameters are used to specify the CNode in which to place the new capabilities.
Depending on the <code class="highlighter-rouge">depth</code> parameter, the CSlot to use is addressed by invocation or by direct addressing.</p>

<p>In the example above, <code class="highlighter-rouge">node_depth</code> is set to 0, which means that the <code class="highlighter-rouge">root</code> parameter is looked up implicitly
using the CSpace root of the current thread at a depth of <code class="highlighter-rouge">seL4_WordBits</code>. So the example code specifies
the root task’s CNode (<code class="highlighter-rouge">seL4_CapInitThreadCNode</code>). The <code class="highlighter-rouge">node_index</code> parameter in this case is ignored.</p>

<p>If the <code class="highlighter-rouge">node_depth</code> value is not set to 0, then direct addressing is used with the current thread’s cspace root
as the root. Then the <code class="highlighter-rouge">node_index</code> parameter is used to locate the CNode capability to place new capabilities in,
at the specified <code class="highlighter-rouge">node_depth</code>. This is designed for managing multi-level CSpaces, and is not covered in this tutorial.</p>

<h4 id="node_offset">Node_offset</h4>

<p>The node_offset is the CSlot to start creating new capabilities at, in the CNode selected by the previous parameters.
 In this case, the first empty CSlot in the initial CNode is selected.</p>

<h4 id="num_caps">Num_caps</h4>

<p>The retype invocation can be used to create more than 1 capability at a time – the amount of capabilities is specified
using this argument. Note that there are two constraints on this value:</p>
<ol>
  <li>The untyped must be big enough to fit all of the memory being retyped (<code class="highlighter-rouge">num_caps * (1u &lt;&lt; size_bits)</code>).</li>
  <li>The CNode must have enough consecutive free CSlots to fit all of the new capabilities.</li>
</ol>

<h2 id="exercises">Exercises</h2>

<h3 id="create-an-untyped">Create an untyped</h3>

<p>When you first run this tutorial, you will see something like the following output, which lists all of the
untyped capabilities provided to the root task on boot:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Booting all finished, dropped to user space
    CSlot   	Paddr           	Size	Type
   0x12d	        0x100000	2^20	device untyped
   0x12e	        0x200000	2^21	device untyped
   0x12f	        0x400000	2^22	device untyped
   0x130	        0xb2e000	2^13	device untyped
</code></pre></div></div>
<p>At the end of the output, there is an error:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;&lt;seL4(CPU 0) [decodeUntypedInvocation/105 T0xffffff801ffb5400 "rootserver" @4012e1]: Untyped Retype: Requested UntypedItem size too small.&gt;&gt;
main@main.c:49 [Cond failed: error != seL4_NoError]
	Failed to retype
</code></pre></div></div>
<p>This error is because we are trying to create an untyped of size 0.</p>

<p><strong>Exercise</strong> Calculate the size of the child untyped required, such that the child untyped can be used
 to create all of the objects lists in the <code class="highlighter-rouge">objects</code> array.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// list of general seL4 objects
</span>    <span class="n">seL4_Word</span> <span class="n">objects</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">seL4_TCBObject</span><span class="p">,</span> <span class="n">seL4_EndpointObject</span><span class="p">,</span> <span class="n">seL4_NotificationObject</span><span class="p">};</span>
    <span class="c1">// list of general seL4 object size_bits
</span>    <span class="n">seL4_Word</span> <span class="n">sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">seL4_TCBBits</span><span class="p">,</span> <span class="n">seL4_EndpointBits</span><span class="p">,</span> <span class="n">seL4_NotificationBits</span><span class="p">};</span>

    <span class="c1">// TODO work out what size object we need to create to be able to create all of the objects
</span>    <span class="c1">// listed above
</span>    <span class="n">seL4_Word</span> <span class="n">untyped_size_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">seL4_CPtr</span> <span class="n">parent_untyped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">seL4_CPtr</span> <span class="n">child_untyped</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>

    <span class="c1">// First, find an untyped big enough to fit all of our objects
</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">untyped</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">untyped</span><span class="p">.</span><span class="n">start</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">untypedList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeBits</span> <span class="o">&gt;=</span> <span class="n">untyped_size_bits</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">parent_untyped</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">untyped</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>On success, the tutorial will progress further, printing “Failed to set priority”</p>

<h3 id="create-a-tcb-object">Create a TCB Object</h3>

<p>The priority check is failing as <code class="highlighter-rouge">child_tcb</code> is an empty CSlot.</p>

<p><strong>Exercise</strong> fix this by creating a TCB object from <code class="highlighter-rouge">child_untyped</code> placed in <code class="highlighter-rouge">child_tcb</code> CSlot.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">seL4_CPtr</span> <span class="n">child_tcb</span> <span class="o">=</span> <span class="n">child_untyped</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cm">/* TODO create a TCB in CSlot child_tcb */</span>

    <span class="c1">// try to set the TCB priority
</span>    <span class="n">error</span> <span class="o">=</span> <span class="n">seL4_TCB_SetPriority</span><span class="p">(</span><span class="n">child_tcb</span><span class="p">,</span> <span class="n">seL4_CapInitThreadTCB</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">ZF_LOGF_IF</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">seL4_NoError</span><span class="p">,</span> <span class="s">"Failed to set priority"</span><span class="p">);</span>
</code></pre></div></div>

<p>On success, the tutorial will progress further, printing “Endpoint cap is null cap”.</p>
<h3 id="create-an-endpoint-object">Create an endpoint object</h3>

<p>The error you see now is caused be an invalid endpoint capability.</p>

<p><strong>Exercise</strong> Create an endpoint object from <code class="highlighter-rouge">child_untyped</code> and place it in the <code class="highlighter-rouge">child_ep</code> CSlot.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">seL4_CPtr</span> <span class="n">child_ep</span> <span class="o">=</span> <span class="n">child_tcb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cm">/* TODO create an endpoint in CSlot child_ep */</span>

    <span class="c1">// identify the type of child_ep
</span>    <span class="kt">uint32_t</span> <span class="n">cap_id</span> <span class="o">=</span> <span class="n">seL4_DebugCapIdentify</span><span class="p">(</span><span class="n">child_ep</span><span class="p">);</span>
    <span class="n">ZF_LOGF_IF</span><span class="p">(</span><span class="n">cap_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"Endpoint cap is null cap"</span><span class="p">);</span>
</code></pre></div></div>
<p>On success, ‘Failed to bind notification’ should be output.</p>
<h3 id="create-a-notification-object">Create a notification object</h3>
<p>The next part of the tutorial attempts to use a notification object that does not yet exist.</p>

<p><strong>Exercise</strong> create a notification object from <code class="highlighter-rouge">child_untyped</code> and place it in the <code class="highlighter-rouge">child_ntfn</code> CSlot.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">seL4_CPtr</span> <span class="n">child_ntfn</span> <span class="o">=</span> <span class="n">child_ep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// TODO create a notification object in CSlot child_ntfn
</span>
    <span class="c1">// try to use child_ntfn
</span>    <span class="n">error</span> <span class="o">=</span> <span class="n">seL4_TCB_BindNotification</span><span class="p">(</span><span class="n">child_tcb</span><span class="p">,</span> <span class="n">child_ntfn</span><span class="p">);</span>
    <span class="n">ZF_LOGF_IF</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">seL4_NoError</span><span class="p">,</span> <span class="s">"Failed to bind notification."</span><span class="p">);</span>
</code></pre></div></div>
<h3 id="delete-the-objects">Delete the objects</h3>
<p>The final part of the tutorial attempts to create enough endpoint objects from <code class="highlighter-rouge">child_untyped</code> to consume the
entire untyped object. However, this fails, because the untyped is already completely consumed by the previous allocations.</p>

<p><strong>Exercise</strong> revoke the child untyped, so we can create new objects from it that use up the whole thing.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// TODO revoke the child untyped
</span>
    <span class="c1">// allocate the whole child_untyped as endpoints
</span>    <span class="n">seL4_Word</span> <span class="n">num_eps</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">untyped_size_bits</span> <span class="o">-</span> <span class="n">seL4_EndpointBits</span><span class="p">);</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">seL4_Untyped_Retype</span><span class="p">(</span><span class="n">child_untyped</span><span class="p">,</span> <span class="n">seL4_EndpointObject</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seL4_CapInitThreadCNode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">child_tcb</span><span class="p">,</span> <span class="n">num_eps</span><span class="p">);</span>
    <span class="n">ZF_LOGF_IF</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">seL4_NoError</span><span class="p">,</span> <span class="s">"Failed to create endpoints."</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Success</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</code></pre></div></div>
<p>Once the tutorial is completed successfully, you should see the message “Success”.</p>

<h3 id="further-exercises">Further exercises</h3>

<p>That’s all for the detailed content of this tutorial. Below we list other ideas for exercises you can try,
to become more familiar with untyped objects and memory allocation in seL4.</p>

<ul>
  <li>Allocate objects at specific physical addresses.</li>
  <li>Create a simple object allocator for allocating seL4 objects.</li>
</ul>

<hr />
<h2 id="getting-help">Getting help</h2>
<p>Stuck? See the resources below.</p>
<ul>
  <li><a href="https://docs.sel4.systems/FrequentlyAskedQuestions">FAQ</a></li>
  <li><a href="http://sel4.systems/Info/Docs/seL4-manual-latest.pdf">seL4 Manual</a></li>
  <li><a href="https://docs.sel4.systems/DebuggingGuide.html">Debugging guide</a></li>
  <li><a href="https://docs.sel4.systems/IRCChannel">IRC Channel</a></li>
  <li><a href="https://sel4.systems/lists/listinfo/devel">Developer’s mailing list</a></li>
</ul>


    </div>
  </div>
</div>

    </main>
    

<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      

<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Tue Nov 6 09:18:35 2018 +1100 44f0df2
          </li>
          <li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                Page last updated: Mon Oct 15 17:13:12 2018 +1100 83f68de
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
      <a href="https://github.com/SEL4PROJ/docs/blob/master/Tutorials/untyped.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/SEL4PROJ/docs/edit/master/Tutorials/untyped.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>
  </body>
</html>
